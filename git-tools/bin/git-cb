#!/bin/bash

# å¼•æ•°ãƒã‚§ãƒƒã‚¯
if [ -z "$1" ]; then
    echo "Usage: git cd <new-branch-name>"
    exit 1
fi

BRANCH_NAME=$1

# æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã®ãƒã‚§ãƒƒã‚¯ï¼ˆä¸Šæ›¸ãäº‹æ•…é˜²æ­¢ï¼‰
# æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã®ãƒã‚§ãƒƒã‚¯
if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
    echo "âš ï¸  Branch '$BRANCH_NAME' already exists."
    git checkout "$BRANCH_NAME"

    # ç¾åœ¨ã®Descriptionã‚’å–å¾—
    CURRENT_DESC=$(git config branch."$BRANCH_NAME".description)

    if [ -n "$CURRENT_DESC" ]; then
        echo "ğŸ“ Description: $CURRENT_DESC"
    else
        echo "â„¹ï¸  No description set."
    fi

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ¡ˆå†…ï¼ˆã“ã“ãŒè¦ªåˆ‡ãªéƒ¨åˆ†ï¼‰
    echo "ğŸ’¡ Run 'git branch --edit-description' to add/edit it."
    exit 0
fi

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
DESC_FILE=$(mktemp)

# Neovimã§é–‹ã (è¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯nvimã‚’ç›´æ¥æŒ‡å®š)
${EDITOR:-nvim} "$DESC_FILE"

# ã€é‡è¦ã€‘ä¸­èº«ã®æ¤œè¨¼
# ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã€ã¾ãŸã¯ã€Œç©ºç™½æ–‡å­—ã®ã¿ã€ã®å ´åˆã¯ä½œæˆã‚’ä¸­æ­¢ã™ã‚‹
if [ ! -s "$DESC_FILE" ] || ! grep -q '[^[:space:]]' "$DESC_FILE"; then
    echo "ğŸš« Description is empty. Branch creation aborted."
    rm "$DESC_FILE"
    exit 1 # ã‚¨ãƒ©ãƒ¼çµ‚äº†
fi

# ãƒ–ãƒ©ãƒ³ãƒä½œæˆã¨switch
echo "Creating branch '$BRANCH_NAME'..."
if git checkout -b "$BRANCH_NAME"; then
    # Descriptionã®è¨­å®š
    git config branch."$BRANCH_NAME".description "$(cat "$DESC_FILE")"
    echo "âœ… Description set."
else
    echo "âŒ Failed to create branch."
    rm "$DESC_FILE"
    exit 1
fi

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
rm "$DESC_FILE"

